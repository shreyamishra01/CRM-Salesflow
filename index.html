<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesFlow CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --danger: #e63946;
            --warning: #fca311;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 70px;
            --bg-color: #f5f7fb;
            --text-color: #212529;
            --card-bg: white;
            --header-bg: white;
            --border-color: #e0e0e0;
        }
        
        .dark-mode {
            --bg-color: #121212;
            --text-color: #f5f7fb;
            --card-bg: #1e1e1e;
            --header-bg: #1e1e1e;
            --border-color: #2d2d2d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: var(--primary);
            color: white;
            padding: 20px;
            transition: all 0.3s ease;
            overflow-x: hidden;
            border-right: 1px solid var(--border-color);
            z-index: 1000;
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 20px;
            right: -15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            border: 2px solid white;
        }
        
        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .logo i {
            font-size: 28px;
            margin-right: 10px;
            transition: margin-right 0.3s ease;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            white-space: nowrap;
            transition: opacity 0.3s ease;
        }
        
        .sidebar.collapsed .logo h1 {
            opacity: 0;
            width: 0;
            height: 0;
            overflow: hidden;
        }
        
        .sidebar.collapsed .logo i {
            margin-right: 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: var(--secondary);
        }
        
        .menu-item i {
            margin-right: 10px;
            font-size: 18px;
            min-width: 24px;
            transition: margin-right 0.3s ease;
        }
        
        .menu-item span {
            transition: opacity 0.3s ease;
        }
        
        .sidebar.collapsed .menu-item span {
            opacity: 0;
            width: 0;
            height: 0;
            overflow: hidden;
        }
        
        .sidebar.collapsed .menu-item i {
            margin-right: 0;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
            margin-left: var(--sidebar-width);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .search-bar input {
            border: none;
            outline: none;
            padding: 5px;
            width: 100%;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }
        
        .search-result-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .search-result-item i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .search-result-item .type {
            font-size: 12px;
            color: var(--gray);
            margin-left: auto;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .notification-container {
            position: relative;
            margin-right: 15px;
        }

        .notification-icon {
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-dropdown {
            position: absolute;
            top: 40px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 350px;
            z-index: 1000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .notification-clear {
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
        }

        .notification-list {
            padding: 0;
        }

        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .notification-icon-wrapper {
            margin-right: 10px;
            color: var(--primary);
            font-size: 16px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--gray);
        }

        .notification-empty {
            padding: 20px;
            text-align: center;
            color: var(--gray);
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 10px;
            color: var(--text-color);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 200px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        
        .dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-color);
            text-decoration: none;
        }
        
        .dropdown-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .stat-card {
            display: flex;
            align-items: center;
        }
        
        .stat-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }
        
        .leads .icon {
            background-color: rgba(67, 97, 238, 0.2);
            color: var(--primary);
        }
        
        .customers .icon {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }
        
        .revenue .icon {
            background-color: rgba(252, 163, 17, 0.2);
            color: var(--warning);
        }
        
        .tasks .icon {
            background-color: rgba(230, 57, 70, 0.2);
            color: var(--danger);
        }
        
        .stat-card .info h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .stat-card .info p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .section-title {
            margin: 30px 0 20px;
            font-size: 20px;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: rgba(248, 249, 250, 0.5);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: rgba(248, 249, 250, 0.3);
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.new {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .status.contacted {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .status.customer {
            background-color: rgba(56, 189, 104, 0.1);
            color: #38bd68;
        }
        
        .status.paid {
            background-color: rgba(56, 189, 104, 0.1);
            color: #38bd68;
        }
        
        .status.pending {
            background-color: rgba(252, 163, 17, 0.1);
            color: var(--warning);
        }
        
        .status.overdue {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 16px;
            margin-right: 10px;
        }
        
        .action-btn:hover {
            color: var(--primary);
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .btn-primary i {
            margin-right: 8px;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-primary:hover i {
            transform: translateX(-3px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .calendar-header {
            grid-column: span 7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .calendar-day {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .calendar-date {
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-color);
            position: relative;
        }
        
        .calendar-date:hover {
            background-color: rgba(0,0,0,0.1);
        }
        
        .calendar-date.active {
            background-color: var(--primary);
            color: white;
        }
        
        .calendar-date.has-event::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            background-color: var(--danger);
            border-radius: 50%;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-color);
            margin-right: 15px;
        }
        
        .chart-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            position: relative;
            height: 300px;
        }
        
        .revenue-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .revenue-stat {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .revenue-stat h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .revenue-stat p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .revenue-stat .trend {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .trend.up {
            color: #38bd68;
        }
        
        .trend.down {
            color: var(--danger);
        }
        
        .event-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .event-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-view {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: none;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .detail-field {
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .detail-value {
            font-size: 16px;
        }
        
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 992px) {
            .sidebar {
                width: var(--sidebar-collapsed-width);
                padding: 20px 10px;
            }
            
            .sidebar:not(.collapsed) {
                width: var(--sidebar-width);
            }
            
            .logo h1, .menu-item span {
                display: none;
            }
            
            .sidebar:not(.collapsed) .logo h1, 
            .sidebar:not(.collapsed) .menu-item span {
                display: block;
            }
            
            .logo {
                justify-content: center;
            }
            
            .sidebar:not(.collapsed) .logo {
                justify-content: flex-start;
            }
            
            .menu-item {
                justify-content: center;
            }
            
            .sidebar:not(.collapsed) .menu-item {
                justify-content: flex-start;
            }
            
            .menu-item i {
                margin-right: 0;
            }
            
            .sidebar:not(.collapsed) .menu-item i {
                margin-right: 10px;
            }
            
            .search-bar {
                width: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .search-bar {
                width: 200px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                height: 100%;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.show-mobile {
                left: 0;
            }
            
            .sidebar.collapsed {
                left: 0;
                width: var(--sidebar-collapsed-width);
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .revenue-stats {
                grid-template-columns: 1fr;
            }
            
            .detail-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Mobile Menu Toggle -->
    <div class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle" id="sidebar-toggle">
            <i class="fas fa-chevron-left"></i>
        </div>
        <div class="logo">
            <div style="width: 28px; margin-right: 26px;"></div>
            <!-- <i class="fas fa-stream"></i> -->
            <h1>SalesFlow CRM</h1>
        </div>
        <div class="menu-item active" data-tab="dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </div>
        <div class="menu-item" data-tab="contacts">
            <i class="fas fa-users"></i>
            <span>Contacts</span>
        </div>
        <div class="menu-item" data-tab="leads">
            <i class="fas fa-chart-line"></i>
            <span>Leads</span>
        </div>
        <div class="menu-item" data-tab="revenue">
            <i class="fas fa-dollar-sign"></i>
            <span>Revenue</span>
        </div>
        <div class="menu-item" data-tab="tasks">
            <i class="fas fa-tasks"></i>
            <span>Tasks</span>
        </div>
        <div class="menu-item" data-tab="calendar">
            <i class="fas fa-calendar"></i>
            <span>Calendar</span>
        </div>
        <div class="menu-item" data-tab="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Header -->
        <div class="header">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Search contacts, leads, tasks...">
                <div class="search-results" id="search-results">
                    <!-- Search results will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="header-right">
                <button class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="notification-container">
                    <div class="notification-icon" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-badge">0</span>
                    </div>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <span class="notification-clear" onclick="clearAllNotifications()">Clear all</span>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- User Menu -->
                <div class="user-menu">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="avatar" id="userAvatar">JD</div>
                        <span id="userName">John Doe</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="dropdown" id="userDropdown">
                        <a href="#" class="dropdown-item" onclick="openSettings()">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <a href="#" class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <!-- Dashboard Stats -->
            <div class="dashboard-cards">
                <div class="card stat-card leads">
                    <div class="icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="info">
                        <h3 id="leads-count">142</h3>
                        <p>Leads</p>
                    </div>
                </div>
                <div class="card stat-card customers">
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="info">
                        <h3 id="contacts-count">86</h3>
                        <p>Customers</p>
                    </div>
                </div>
                <div class="card stat-card revenue">
                    <div class="icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="info">
                        <h3 id="revenue-amount">$42,560</h3>
                        <p>Revenue</p>
                    </div>
                </div>
                <div class="card stat-card tasks">
                    <div class="icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="info">
                        <h3 id="tasks-count">9</h3>
                        <p>Pending Tasks</p>
                    </div>
                </div>
            </div>

            <!-- Recent Leads -->
            <h2 class="section-title">Recent Leads</h2>
            <table id="leads-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Leads will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Upcoming Activities -->
            <h2 class="section-title" style="margin-top: 30px;">Upcoming Activities</h2>
            <table id="tasks-table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Related To</th>
                        <th>Due Date</th>
                        <th>Priority</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Tasks will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Contacts Tab -->
        <div class="tab-content" id="contacts">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="section-title">Contacts</h2>
                <button class="btn-primary" id="add-contact-btn">
                    <i class="fas fa-plus"></i> Add Contact
                </button>
            </div>
            
            <!-- Detail View -->
            <div class="detail-view" id="contact-detail-view">
                <div class="detail-header">
                    <h2 id="contact-detail-name">Contact Name</h2>
                    <button class="btn-primary" id="back-to-contacts">
                        <i class="fas fa-arrow-left"></i> Back to Contacts
                    </button>
                </div>
                <div class="detail-content" id="contact-detail-content">
                    <!-- Contact details will be populated here -->
                </div>
            </div>
            
            <!-- Contacts Table -->
            <table id="contacts-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Company</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Contacts will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Leads Tab -->
        <div class="tab-content" id="leads">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="section-title">Leads</h2>
                <button class="btn-primary" id="add-lead-btn">
                    <i class="fas fa-plus"></i> Add Lead
                </button>
            </div>
            
            <!-- Detail View -->
            <div class="detail-view" id="lead-detail-view">
                <div class="detail-header">
                    <h2 id="lead-detail-name">Lead Name</h2>
                    <button class="btn-primary" id="back-to-leads">
                        <i class="fas fa-arrow-left"></i> Back to Leads
                    </button>
                </div>
                <div class="detail-content" id="lead-detail-content">
                    <!-- Lead details will be populated here -->
                </div>
            </div>
            
            <table id="leads-management-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Leads will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Revenue Tab -->
        <div class="tab-content" id="revenue">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="section-title">Revenue</h2>
                <button class="btn-primary" id="add-invoice-btn">
                    <i class="fas fa-plus"></i> Add Invoice
                </button>
            </div>

            <!-- Detail View -->
            <div class="detail-view" id="invoice-detail-view">
                <div class="detail-header">
                    <h2 id="invoice-detail-title">Invoice Details</h2>
                    <button class="btn-primary" id="back-to-invoices">
                        <i class="fas fa-arrow-left"></i> Back to Invoices
                    </button>
                </div>
                <div class="detail-content" id="invoice-detail-content">
                    <!-- Invoice details will be populated here -->
                </div>
            </div>

            <!-- Revenue Stats -->
            <div class="revenue-stats">
                <div class="revenue-stat">
                    <h3 id="total-revenue">$42,560</h3>
                    <p>Total Revenue</p>
                    <div class="trend up">+12% from last month</div>
                </div>
                <div class="revenue-stat">
                    <h3 id="paid-invoices">$38,240</h3>
                    <p>Paid Invoices</p>
                    <div class="trend up">+8% from last month</div>
                </div>
                <div class="revenue-stat">
                    <h3 id="outstanding">$4,320</h3>
                    <p>Outstanding</p>
                    <div class="trend down">+15% from last month</div>
                </div>
                <div class="revenue-stat">
                    <h3 id="avg-invoice">$1,240</h3>
                    <p>Average Invoice</p>
                    <div class="trend up">+5% from last month</div>
                </div>
            </div>

            <!-- Revenue Chart -->
            <div class="chart-container">
                <h3>Revenue Overview</h3>
                <canvas id="revenue-chart"></canvas>
            </div>

            <!-- Invoices Table -->
            <h2 class="section-title">Recent Invoices</h2>
            <table id="invoices-table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Client</th>
                        <th>Date</th>
                        <th>Due Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Invoices will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Tasks Tab -->
        <div class="tab-content" id="tasks">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="section-title">Tasks</h2>
                <button class="btn-primary" id="add-task-btn">
                    <i class="fas fa-plus"></i> Add Task
                </button>
            </div>
            
            <!-- Detail View -->
            <div class="detail-view" id="task-detail-view">
                <div class="detail-header">
                    <h2 id="task-detail-title">Task Title</h2>
                    <button class="btn-primary" id="back-to-tasks">
                        <i class="fas fa-arrow-left"></i> Back to Tasks
                    </button>
                </div>
                <div class="detail-content" id="task-detail-content">
                    <!-- Task details will be populated here -->
                </div>
            </div>
            
            <table id="tasks-management-table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Related To</th>
                        <th>Due Date</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Tasks will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Calendar Tab -->
        <div class="tab-content" id="calendar">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="section-title">Calendar</h2>
                <button class="btn-primary" id="add-event-btn">
                    <i class="fas fa-plus"></i> Add Event
                </button>
            </div>
            <div class="calendar">
                <div class="calendar-header">
                    <button class="btn-primary" id="prev-month">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h3 id="current-month">June 2023</h3>
                    <button class="btn-primary" id="next-month">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-day">Sun</div>
                <div class="calendar-day">Mon</div>
                <div class="calendar-day">Tue</div>
                <div class="calendar-day">Wed</div>
                <div class="calendar-day">Thu</div>
                <div class="calendar-day">Fri</div>
                <div class="calendar-day">Sat</div>
                <!-- Calendar dates will be populated by JavaScript -->
            </div>
            
            <h2 class="section-title" style="margin-top: 30px;">Upcoming Events</h2>
            <table id="events-table">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Location</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Events will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <h2 class="section-title">Settings</h2>
            
            <div class="card">
                <h3 style="margin-bottom: 20px;">Appearance</h3>
                <div class="form-group">
                    <label for="theme-select">Theme</label>
                    <select id="theme-select" class="theme-select">
                        <option value="light">Light Mode</option>
                        <option value="dark">Dark Mode</option>
                        <option value="auto">Auto (System Default)</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="applyThemeSettings()">
                    Apply Theme
                </button>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <button class="btn-primary" style="background-color: var(--danger);" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div class="modal" id="contact-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contact-modal-title">Add New Contact</h2>
                <span class="close">&times;</span>
            </div>
            <input type="hidden" id="contact-id">
            <div class="form-group">
                <label for="contact-name">Name</label>
                <input type="text" id="contact-name" placeholder="Enter name">
            </div>
            <div class="form-group">
                <label for="contact-email">Email</label>
                <input type="email" id="contact-email" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label for="contact-phone">Phone</label>
                <input type="tel" id="contact-phone" placeholder="Enter phone number">
            </div>
            <div class="form-group">
                <label for="contact-company">Company</label>
                <input type="text" id="contact-company" placeholder="Enter company">
            </div>
            <div class="form-group">
                <label for="contact-status">Status</label>
                <select id="contact-status">
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="customer">Customer</option>
                </select>
            </div>
            <button class="btn-primary" id="save-contact">Save Contact</button>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal" id="lead-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="lead-modal-title">Add New Lead</h2>
                <span class="close">&times;</span>
            </div>
            <input type="hidden" id="lead-id">
            <div class="form-group">
                <label for="lead-name">Name</label>
                <input type="text" id="lead-name" placeholder="Enter name">
            </div>
            <div class="form-group">
                <label for="lead-company">Company</label>
                <input type="text" id="lead-company" placeholder="Enter company">
            </div>
            <div class="form-group">
                <label for="lead-email">Email</label>
                <input type="email" id="lead-email" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label for="lead-phone">Phone</label>
                <input type="tel" id="lead-phone" placeholder="Enter phone number">
            </div>
            <div class="form-group">
                <label for="lead-status">Status</label>
                <select id="lead-status">
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="customer">Customer</option>
                </select>
            </div>
            <button class="btn-primary" id="save-lead">Save Lead</button>
        </div>
    </div>

    <!-- Add Invoice Modal -->
    <div class="modal" id="invoice-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="invoice-modal-title">Add New Invoice</h2>
                <span class="close">&times;</span>
            </div>
            <input type="hidden" id="invoice-id">
            <div class="form-group">
                <label for="invoice-client">Client</label>
                <select id="invoice-client">
                    <option value="">Select a client</option>
                    <!-- Clients will be populated by JavaScript -->
                </select>
            </div>
            <div class="form-group">
                <label for="invoice-amount">Amount ($)</label>
                <input type="number" id="invoice-amount" placeholder="Enter amount" step="0.01">
            </div>
            <div class="form-group">
                <label for="invoice-date">Issue Date</label>
                <input type="date" id="invoice-date">
            </div>
            <div class="form-group">
                <label for="invoice-due-date">Due Date</label>
                <input type="date" id="invoice-due-date">
            </div>
            <div class="form-group">
                <label for="invoice-status">Status</label>
                <select id="invoice-status">
                    <option value="paid">Paid</option>
                    <option value="pending">Pending</option>
                    <option value="overdue">Overdue</option>
                </select>
            </div>
            <div class="form-group">
                <label for="invoice-description">Description</label>
                <textarea id="invoice-description" placeholder="Enter invoice description"></textarea>
            </div>
            <button class="btn-primary" id="save-invoice">Save Invoice</button>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="task-modal-title">Add New Task</h2>
                <span class="close">&times;</span>
            </div>
            <input type="hidden" id="task-id">
            <div class="form-group">
                <label for="task-title">Task Title</label>
                <input type="text" id="task-title" placeholder="Enter task title">
            </div>
            <div class="form-group">
                <label for="task-related">Related To</label>
                <input type="text" id="task-related" placeholder="Enter related contact or company">
            </div>
            <div class="form-group">
                <label for="task-date">Due Date</label>
                <input type="date" id="task-date">
            </div>
            <div class="form-group">
                <label for="task-priority">Priority</label>
                <select id="task-priority">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="form-group">
                <label for="task-status">Status</label>
                <select id="task-status">
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <button class="btn-primary" id="save-task">Save Task</button>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="event-modal-title">Add New Event</h2>
                <span class="close">&times;</span>
            </div>
            <input type="hidden" id="event-id">
            <div class="form-group">
                <label for="event-title">Event Title</label>
                <input type="text" id="event-title" placeholder="Enter event title">
            </div>
            <div class="form-group">
                <label for="event-date">Date</label>
                <input type="date" id="event-date">
            </div>
            <div class="form-group">
                <label for="event-time">Time</label>
                <input type="time" id="event-time">
            </div>
            <div class="form-group">
                <label for="event-location">Location</label>
                <input type="text" id="event-location" placeholder="Enter event location">
            </div>
            <div class="form-group">
                <label for="event-description">Description</label>
                <textarea id="event-description" placeholder="Enter event description"></textarea>
            </div>
            <button class="btn-primary" id="save-event">Save Event</button>
        </div>
    </div>

    <script>
        // Authentication check
        const token = localStorage.getItem("token");
        if (!token) {
            alert("You must log in first.");
            window.location.href = "login.html";
        }

        async function checkAuth() {
            try {
                const res = await fetch("/api/protected", {
                    headers: { "Authorization": "Bearer " + token }
                });
                
                if (!res.ok) {
                    localStorage.removeItem("token");
                    alert("Session expired. Please log in again.");
                    window.location.href = "login.html";
                } else {
                    const data = await res.json();
                    // Update user info if available
                    const user = JSON.parse(localStorage.getItem("user"));
                    if (user) {
                        document.getElementById("userName").textContent = user.name;
                        document.getElementById("userAvatar").textContent = 
                            user.name.split(" ").map(n => n[0]).join("").toUpperCase();
                    }
                }
            } catch (error) {
                console.error("Auth check error:", error);
                localStorage.removeItem("token");
                alert("Authentication error. Please log in again.");
                window.location.href = "login.html";
            }
        }

        // Data storage
        let contacts = JSON.parse(localStorage.getItem('crm_contacts')) || [
            {id: 1, name: "Sarah Johnson", email: "sarah@techsolutions.com", phone: "(555) 123-4567", company: "TechSolutions Inc.", status: "new"},
            {id: 2, name: "Michael Chen", email: "michael@globalent.com", phone: "(555) 987-6543", company: "Global Enterprises", status: "contacted"},
            {id: 3, name: "Emily Williams", email: "emily@innovatelabs.com", phone: "(555) 456-7890", company: "Innovate Labs", status: "new"},
            {id: 4, name: "David Rodriguez", email: "david@futuretech.com", phone: "(555) 234-5678", company: "FutureTech", status: "customer"},
            {id: 5, name: "Jessica Miller", email: "jessica@datasystems.com", phone: "(555) 876-5432", company: "DataSystems Co.", status: "contacted"}
        ];
        
        let leads = JSON.parse(localStorage.getItem('crm_leads')) || [
            {id: 1, name: "Sarah Johnson", company: "TechSolutions Inc.", email: "sarah@techsolutions.com", phone: "(555) 123-4567", status: "new"},
            {id: 2, name: "Michael Chen", company: "Global Enterprises", email: "michael@globalent.com", phone: "(555) 987-6543", status: "contacted"},
            {id: 3, name: "Emily Williams", company: "Innovate Labs", email: "emily@innovatelabs.com", phone: "(555) 456-7890", status: "new"},
            {id: 4, name: "David Rodriguez", company: "FutureTech", email: "david@futuretech.com", phone: "(555) 234-5678", status: "customer"},
            {id: 5, name: "Jessica Miller", company: "DataSystems Co.", email: "jessica@datasystems.com", phone: "(555) 876-5432", status: "contacted"}
        ];
        
        let tasks = JSON.parse(localStorage.getItem('crm_tasks')) || [
            {id: 1, title: "Follow-up call", related: "Sarah Johnson", date: "2023-06-15", priority: "high", status: "pending"},
            {id: 2, title: "Send proposal", related: "Global Enterprises", date: "2023-06-16", priority: "medium", status: "in-progress"},
            {id: 3, title: "Product demo", related: "Innovate Labs", date: "2023-06-15", priority: "medium", status: "scheduled"},
            {id: 4, title: "Contract renewal", related: "FutureTech", date: "2023-06-20", priority: "low", status: "not-started"}
        ];
        
        let events = JSON.parse(localStorage.getItem('crm_events')) || [
            {id: 1, title: "Team Meeting", date: "2023-06-15", time: "10:00", location: "Conference Room A"},
            {id: 2, title: "Client Presentation", date: "2023-06-18", time: "14:30", location: "Client Office"},
            {id: 3, title: "Product Launch", date: "2023-06-22", time: "11:00", location: "Main Hall"}
        ];
        
        let invoices = JSON.parse(localStorage.getItem('crm_invoices')) || [
            {id: 1, client: "TechSolutions Inc.", date: "2023-06-01", dueDate: "2023-06-15", amount: 5200, status: "paid", description: "Q2 Maintenance Contract"},
            {id: 2, client: "Global Enterprises", date: "2023-06-05", dueDate: "2023-06-20", amount: 8750, status: "paid", description: "Software Implementation"},
            {id: 3, client: "Innovate Labs", date: "2023-06-10", dueDate: "2023-06-25", amount: 3200, status: "pending", description: "Consulting Services"},
            {id: 4, client: "FutureTech", date: "2023-05-25", dueDate: "2023-06-10", amount: 4500, status: "overdue", description: "Custom Development"},
            {id: 5, client: "DataSystems Co.", date: "2023-06-15", dueDate: "2023-06-30", amount: 6100, status: "pending", description: "Data Migration Project"}
        ];
        
        // Revenue chart instance
        let revenueChart = null;
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('crm_contacts', JSON.stringify(contacts));
            localStorage.setItem('crm_leads', JSON.stringify(leads));
            localStorage.setItem('crm_tasks', JSON.stringify(tasks));
            localStorage.setItem('crm_events', JSON.stringify(events));
            localStorage.setItem('crm_invoices', JSON.stringify(invoices));
            updateUI();
            checkForNotifications();
        }
        
        // Initialize revenue chart
        function initRevenueChart() {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            // Generate monthly revenue data from invoices
            const monthlyRevenue = generateMonthlyRevenueData();
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [
                        {
                            label: 'Revenue',
                            data: monthlyRevenue,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            tension: 0.3,
                            fill: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        },
                        y: {
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Generate monthly revenue data from invoices
        function generateMonthlyRevenueData() {
            const monthlyRevenue = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            
            invoices.forEach(invoice => {
                if (invoice.status === 'paid') {
                    const month = new Date(invoice.date).getMonth();
                    monthlyRevenue[month] += invoice.amount;
                }
            });
            
            return monthlyRevenue;
        }
        
        // Update chart colors when theme changes
        function updateChartColors() {
            if (revenueChart) {
                revenueChart.options.scales.x.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                revenueChart.options.scales.x.grid.color = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
                revenueChart.options.scales.y.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                revenueChart.options.scales.y.grid.color = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
                revenueChart.options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                revenueChart.update();
            }
        }
        
        // Update UI with current data
        function updateUI() {
            // Update counts
            document.getElementById('leads-count').textContent = leads.length;
            document.getElementById('contacts-count').textContent = contacts.length;
            document.getElementById('tasks-count').textContent = tasks.filter(task => task.status === 'pending').length;
            
            // Calculate revenue stats
            const totalRevenue = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + inv.amount, 0);
            const outstanding = invoices.filter(inv => inv.status !== 'paid').reduce((sum, inv) => sum + inv.amount, 0);
            const paidInvoices = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + inv.amount, 0);
            const avgInvoice = invoices.length > 0 ? Math.round(invoices.reduce((sum, inv) => sum + inv.amount, 0) / invoices.length) : 0;
            
            document.getElementById('revenue-amount').textContent = `$${totalRevenue.toLocaleString()}`;
            document.getElementById('total-revenue').textContent = `$${totalRevenue.toLocaleString()}`;
            document.getElementById('paid-invoices').textContent = `$${paidInvoices.toLocaleString()}`;
            document.getElementById('outstanding').textContent = `$${outstanding.toLocaleString()}`;
            document.getElementById('avg-invoice').textContent = `$${avgInvoice.toLocaleString()}`;
            
            // Update revenue chart
            initRevenueChart();
            
            // Update leads table
            const leadsTable = document.getElementById('leads-table').querySelector('tbody');
            leadsTable.innerHTML = '';
            leads.slice(0, 5).forEach(lead => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lead.name}</td>
                    <td>${lead.company}</td>
                    <td>${lead.email}</td>
                    <td>${lead.phone}</td>
                    <td><span class="status ${lead.status}">${lead.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewItem('lead', ${lead.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="editItem('lead', ${lead.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="deleteLead(${lead.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                leadsTable.appendChild(row);
            });
            
            // Update tasks table
            const tasksTable = document.getElementById('tasks-table').querySelector('tbody');
            tasksTable.innerHTML = '';
            tasks.slice(0, 5).forEach(task => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.title}</td>
                    <td>${task.related}</td>
                    <td>${formatDate(task.date)}</td>
                    <td><span style="color: ${getPriorityColor(task.priority)};">${task.priority}</span></td>
                    <td>${task.status}</td>
                `;
                tasksTable.appendChild(row);
            });
            
            // Update contacts table
            const contactsTable = document.getElementById('contacts-table').querySelector('tbody');
            contactsTable.innerHTML = '';
            contacts.forEach(contact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${contact.name}</td>
                    <td>${contact.email}</td>
                    <td>${contact.phone}</td>
                    <td>${contact.company}</td>
                    <td><span class="status ${contact.status}">${contact.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewItem('contact', ${contact.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="editItem('contact', ${contact.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="deleteContact(${contact.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                contactsTable.appendChild(row);
            });
            
            // Update leads management table
            const leadsManagementTable = document.getElementById('leads-management-table').querySelector('tbody');
            leadsManagementTable.innerHTML = '';
            leads.forEach(lead => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lead.name}</td>
                    <td>${lead.company}</td>
                    <td>${lead.email}</td>
                    <td>${lead.phone}</td>
                    <td><span class="status ${lead.status}">${lead.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewItem('lead', ${lead.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="editItem('lead', ${lead.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="deleteLead(${lead.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                leadsManagementTable.appendChild(row);
            });
            
            // Update tasks management table
            const tasksManagementTable = document.getElementById('tasks-management-table').querySelector('tbody');
            tasksManagementTable.innerHTML = '';
            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.title}</td>
                    <td>${task.related}</td>
                    <td>${formatDate(task.date)}</td>
                    <td><span style="color: ${getPriorityColor(task.priority)};">${task.priority}</span></td>
                    <td>${task.status}</td>
                    <td>
                        <button class="action-btn" onclick="viewItem('task', ${task.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="editItem('task', ${task.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="deleteTask(${task.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tasksManagementTable.appendChild(row);
            });
            
            // Update events table
            const eventsTable = document.getElementById('events-table').querySelector('tbody');
            eventsTable.innerHTML = '';
            events.forEach(event => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${event.title}</td>
                    <td>${formatDate(event.date)}</td>
                    <td>${event.time}</td>
                    <td>${event.location}</td>
                    <td>
                        <button class="action-btn" onclick="viewItem('event', ${event.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="editItem('event', ${event.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="deleteEvent(${event.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                eventsTable.appendChild(row);
            });
            
            // Update invoices table
            const invoicesTable = document.getElementById('invoices-table').querySelector('tbody');
            invoicesTable.innerHTML = '';
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>INV-${String(invoice.id).padStart(4, '0')}</td>
                    <td>${invoice.client}</td>
                    <td>${formatDate(invoice.date)}</td>
                    <td>${formatDate(invoice.dueDate)}</td>
                    <td>$${invoice.amount.toLocaleString()}</td>
                    <td><span class="status ${invoice.status}">${invoice.status}</span></td>
                    <td>
                        <button class="action-btn" onclick="viewItem('invoice', ${invoice.id})"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="editItem('invoice', ${invoice.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="deleteInvoice(${invoice.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                invoicesTable.appendChild(row);
            });
            
            // Update calendar
            renderCalendar();
        }
        
        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Get priority color
        function getPriorityColor(priority) {
            switch(priority) {
                case 'high': return 'var(--danger)';
                case 'medium': return 'var(--warning)';
                case 'low': return 'var(--success)';
                default: return 'var(--gray)';
            }
        }
        
        // View item details
        function viewItem(type, id) {
            let item, title, content;
            
            switch(type) {
                case 'contact':
                    item = contacts.find(c => c.id === id);
                    title = item.name;
                    content = `
                        <div class="detail-field">
                            <div class="detail-label">Name</div>
                            <div class="detail-value">${item.name}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${item.email}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${item.phone}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Company</div>
                            <div class="detail-value">${item.company}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status ${item.status}">${item.status}</span></div>
                        </div>
                    `;
                    document.getElementById('contact-detail-name').textContent = title;
                    document.getElementById('contact-detail-content').innerHTML = content;
                    document.getElementById('contact-detail-view').style.display = 'block';
                    document.getElementById('contacts-table').style.display = 'none';
                    break;
                    
                case 'lead':
                    item = leads.find(l => l.id === id);
                    title = item.name;
                    content = `
                        <div class="detail-field">
                            <div class="detail-label">Name</div>
                            <div class="detail-value">${item.name}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Company</div>
                            <div class="detail-value">${item.company}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${item.email}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${item.phone}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status ${item.status}">${item.status}</span></div>
                        </div>
                    `;
                    document.getElementById('lead-detail-name').textContent = title;
                    document.getElementById('lead-detail-content').innerHTML = content;
                    document.getElementById('lead-detail-view').style.display = 'block';
                    document.getElementById('leads-management-table').style.display = 'none';
                    break;
                    
                case 'task':
                    item = tasks.find(t => t.id === id);
                    title = item.title;
                    content = `
                        <div class="detail-field">
                            <div class="detail-label">Title</div>
                            <div class="detail-value">${item.title}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Related To</div>
                            <div class="detail-value">${item.related}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Due Date</div>
                            <div class="detail-value">${formatDate(item.date)}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Priority</div>
                            <div class="detail-value" style="color: ${getPriorityColor(item.priority)};">${item.priority}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${item.status}</div>
                        </div>
                    `;
                    document.getElementById('task-detail-title').textContent = title;
                    document.getElementById('task-detail-content').innerHTML = content;
                    document.getElementById('task-detail-view').style.display = 'block';
                    document.getElementById('tasks-management-table').style.display = 'none';
                    break;
                    
                case 'invoice':
                    item = invoices.find(i => i.id === id);
                    title = `Invoice #INV-${String(item.id).padStart(4, '0')}`;
                    content = `
                        <div class="detail-field">
                            <div class="detail-label">Invoice Number</div>
                            <div class="detail-value">INV-${String(item.id).padStart(4, '0')}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Client</div>
                            <div class="detail-value">${item.client}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Amount</div>
                            <div class="detail-value">$${item.amount.toLocaleString()}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Issue Date</div>
                            <div class="detail-value">${formatDate(item.date)}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Due Date</div>
                            <div class="detail-value">${formatDate(item.dueDate)}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Status</div>
                            <div class="detail-value"><span class="status ${item.status}">${item.status}</span></div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Description</div>
                            <div class="detail-value">${item.description}</div>
                        </div>
                    `;
                    document.getElementById('invoice-detail-title').textContent = title;
                    document.getElementById('invoice-detail-content').innerHTML = content;
                    document.getElementById('invoice-detail-view').style.display = 'block';
                    document.getElementById('invoices-table').style.display = 'none';
                    break;
                    
                case 'event':
                    item = events.find(e => e.id === id);
                    showEventDetails(item.date);
                    return;
            }
        }
        
        // Edit item
        function editItem(type, id) {
            let item;
            
            switch(type) {
                case 'contact':
                    item = contacts.find(c => c.id === id);
                    document.getElementById('contact-modal-title').textContent = 'Edit Contact';
                    document.getElementById('contact-id').value = item.id;
                    document.getElementById('contact-name').value = item.name;
                    document.getElementById('contact-email').value = item.email;
                    document.getElementById('contact-phone').value = item.phone;
                    document.getElementById('contact-company').value = item.company;
                    document.getElementById('contact-status').value = item.status;
                    document.getElementById('contact-modal').style.display = 'flex';
                    break;
                    
                case 'lead':
                    item = leads.find(l => l.id === id);
                    document.getElementById('lead-modal-title').textContent = 'Edit Lead';
                    document.getElementById('lead-id').value = item.id;
                    document.getElementById('lead-name').value = item.name;
                    document.getElementById('lead-company').value = item.company;
                    document.getElementById('lead-email').value = item.email;
                    document.getElementById('lead-phone').value = item.phone;
                    document.getElementById('lead-status').value = item.status;
                    document.getElementById('lead-modal').style.display = 'flex';
                    break;
                    
                case 'task':
                    item = tasks.find(t => t.id === id);
                    document.getElementById('task-modal-title').textContent = 'Edit Task';
                    document.getElementById('task-id').value = item.id;
                    document.getElementById('task-title').value = item.title;
                    document.getElementById('task-related').value = item.related;
                    document.getElementById('task-date').value = item.date;
                    document.getElementById('task-priority').value = item.priority;
                    document.getElementById('task-status').value = item.status;
                    document.getElementById('task-modal').style.display = 'flex';
                    break;
                    
                case 'invoice':
                    item = invoices.find(i => i.id === id);
                    document.getElementById('invoice-modal-title').textContent = 'Edit Invoice';
                    document.getElementById('invoice-id').value = item.id;
                    document.getElementById('invoice-client').value = item.client;
                    document.getElementById('invoice-amount').value = item.amount;
                    document.getElementById('invoice-date').value = item.date;
                    document.getElementById('invoice-due-date').value = item.dueDate;
                    document.getElementById('invoice-status').value = item.status;
                    document.getElementById('invoice-description').value = item.description;
                    document.getElementById('invoice-modal').style.display = 'flex';
                    break;
                    
                case 'event':
                    item = events.find(e => e.id === id);
                    document.getElementById('event-modal-title').textContent = 'Edit Event';
                    document.getElementById('event-id').value = item.id;
                    document.getElementById('event-title').value = item.title;
                    document.getElementById('event-date').value = item.date;
                    document.getElementById('event-time').value = item.time;
                    document.getElementById('event-location').value = item.location;
                    document.getElementById('event-description').value = item.description;
                    document.getElementById('event-modal').style.display = 'flex';
                    break;
            }
        }
        
        // Delete functions
        function deleteContact(id) {
            if (confirm("Are you sure you want to delete this contact?")) {
                contacts = contacts.filter(contact => contact.id !== id);
                saveData();
            }
        }
        
        function deleteLead(id) {
            if (confirm("Are you sure you want to delete this lead?")) {
                leads = leads.filter(lead => lead.id !== id);
                saveData();
            }
        }
        
        function deleteTask(id) {
            if (confirm("Are you sure you want to delete this task?")) {
                tasks = tasks.filter(task => task.id !== id);
                saveData();
            }
        }
        
        function deleteEvent(id) {
            if (confirm("Are you sure you want to delete this event?")) {
                events = events.filter(event => event.id !== id);
                saveData();
            }
        }
        
        function deleteInvoice(id) {
            if (confirm("Are you sure you want to delete this invoice?")) {
                invoices = invoices.filter(invoice => invoice.id !== id);
                saveData();
            }
        }
        
        // Notification system
        let notifications = JSON.parse(localStorage.getItem('crm_notifications')) || [];

        // Check for pending tasks and upcoming events
        function checkForNotifications() {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Check for tasks due today or overdue
            const pendingTasks = tasks.filter(task => {
                const taskDate = new Date(task.date);
                return task.status !== 'completed' && taskDate <= today;
            });
            
            // Check for events happening today or tomorrow
            const upcomingEvents = events.filter(event => {
                const eventDate = new Date(event.date);
                return eventDate >= today && eventDate <= tomorrow;
            });
            
            // Add notifications for pending tasks
            pendingTasks.forEach(task => {
                const notificationExists = notifications.some(n => 
                    n.type === 'task' && n.taskId === task.id && n.date === todayStr
                );
                
                if (!notificationExists) {
                    notifications.push({
                        id: notifications.length > 0 ? Math.max(...notifications.map(n => n.id)) + 1 : 1,
                        type: 'task',
                        taskId: task.id,
                        title: `Pending Task: ${task.title}`,
                        message: `Task "${task.title}" is due on ${formatDate(task.date)}`,
                        date: todayStr,
                        read: false
                    });
                }
            });
            
            // Add notifications for upcoming events
            upcomingEvents.forEach(event => {
                const eventDate = new Date(event.date);
                const isToday = eventDate.toDateString() === today.toDateString();
                const isTomorrow = eventDate.toDateString() === tomorrow.toDateString();
                
                const notificationExists = notifications.some(n => 
                    n.type === 'event' && n.eventId === event.id && n.date === todayStr
                );
                
                if (!notificationExists) {
                    notifications.push({
                        id: notifications.length > 0 ? Math.max(...notifications.map(n => n.id)) + 1 : 1,
                        type: 'event',
                        eventId: event.id,
                        title: `${isToday ? 'Today' : 'Tomorrow'}: ${event.title}`,
                        message: `Event "${event.title}" is ${isToday ? 'today' : 'tomorrow'} at ${event.time || 'all day'}`,
                        date: todayStr,
                        read: false
                    });
                }
            });
            
            // Save notifications and update UI
            saveNotifications();
            updateNotificationUI();
        }

        // Save notifications to localStorage
        function saveNotifications() {
            localStorage.setItem('crm_notifications', JSON.stringify(notifications));
        }

        // Update notification UI
        function updateNotificationUI() {
            const notificationList = document.getElementById('notification-list');
            const notificationBadge = document.getElementById('notification-badge');
            
            if (!notificationList) return;
            
            // Count unread notifications
            const unreadCount = notifications.filter(n => !n.read).length;
            if (notificationBadge) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }
            
            // Update notification list
            notificationList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
                return;
            }
            
            // Show latest notifications first
            const sortedNotifications = [...notifications].reverse();
            
            sortedNotifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationItem.innerHTML = `
                    <div class="notification-icon-wrapper">
                        <i class="fas ${notification.type === 'task' ? 'fa-tasks' : 'fa-calendar'}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatDate(notification.date)}</div>
                    </div>
                `;
                
                notificationItem.addEventListener('click', () => {
                    markNotificationAsRead(notification.id);
                    
                    if (notification.type === 'task') {
                        // Switch to tasks tab
                        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                        document.querySelector('.menu-item[data-tab="tasks"]').classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                        document.getElementById('tasks').classList.add('active');
                    } else if (notification.type === 'event') {
                        // Switch to calendar tab
                        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                        document.querySelector('.menu-item[data-tab="calendar"]').classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                        document.getElementById('calendar').classList.add('active');
                    }
                    
                    toggleNotifications();
                });
                
                notificationList.appendChild(notificationItem);
            });
        }

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Mark notification as read
        function markNotificationAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                saveNotifications();
                updateNotificationUI();
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            notifications = [];
            saveNotifications();
            updateNotificationUI();
        }

        // Close notifications when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.notification-container')) {
                const dropdown = document.getElementById('notification-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        });
        
        // Show event details
        function showEventDetails(dateString) {
            const eventsForDate = events.filter(event => event.date === dateString);
            
            if (eventsForDate.length === 0) return;
            
            // Create a modal to display events
            const eventDetailsModal = document.createElement('div');
            eventDetailsModal.className = 'modal';
            eventDetailsModal.style.display = 'flex';
            eventDetailsModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Events on ${formatDate(dateString)}</h2>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div id="event-details-container">
                        ${eventsForDate.map(event => `
                            <div class="event-item">
                                <h3>${event.title}</h3>
                                <p><strong>Time:</strong> ${event.time || 'All day'}</p>
                                <p><strong>Location:</strong> ${event.location || 'Not specified'}</p>
                                <p><strong>Description:</strong> ${event.description || 'No description'}</p>
                                <div style="margin-top: 10px;">
                                    <button class="action-btn" onclick="editItem('event', ${event.id})"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn" onclick="deleteEvent(${event.id}); this.parentElement.parentElement.parentElement.remove();"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(eventDetailsModal);
            
            // Close modal when clicking outside
            eventDetailsModal.addEventListener('click', (e) => {
                if (e.target === eventDetailsModal) {
                    eventDetailsModal.remove();
                }
            });
        }

        // Calendar functionality
        let currentDate = new Date();
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('current-month').textContent = 
                currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            const calendar = document.querySelector('.calendar');
            // Clear existing dates (keep the header)
            for (let i = calendar.children.length - 1; i >= 7; i--) {
                calendar.removeChild(calendar.children[i]);
            }
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-date';
                calendar.appendChild(emptyCell);
            }
            
            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateCell = document.createElement('div');
                dateCell.className = 'calendar-date';
                dateCell.textContent = day;
                
                // Create date string in YYYY-MM-DD format
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Check if this date has events
                const hasEvent = events.some(event => event.date === dateString);
                
                if (hasEvent) {
                    dateCell.classList.add('has-event');
                    // Make the date clickable to show events
                    dateCell.style.cursor = 'pointer';
                    dateCell.addEventListener('click', () => showEventDetails(dateString));
                }
        
                // Highlight current date
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dateCell.classList.add('active');
                }
                
                calendar.appendChild(dateCell);
            }
        }
        
        // Toggle user menu
        function toggleUserMenu() {
            document.getElementById("userDropdown").classList.toggle("show");
        }
        
        // Close dropdown if clicked outside
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById("userDropdown").classList.remove("show");
            }
        });
        
        // Open settings
        function openSettings() {
            // Switch to settings tab
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.menu-item[data-tab="settings"]').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById('settings').classList.add('active');
            
            // Close dropdown
            document.getElementById("userDropdown").classList.remove("show");
        }
        
        // Logout function
        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }
        
        // Theme functionality
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            
            // Update icon
            const themeIcon = document.querySelector('#theme-toggle i');
            themeIcon.classList.toggle('fa-moon', !isDarkMode);
            themeIcon.classList.toggle('fa-sun', isDarkMode);
            
            // Update chart colors
            updateChartColors();
        }
        
        function applyThemeSettings() {
            const themeSelect = document.getElementById('theme-select');
            const selectedTheme = themeSelect.value;
            
            if (selectedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
            } else if (selectedTheme === 'light') {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            } else {
                // Auto mode - use system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                localStorage.setItem('darkMode', 'auto');
            }
            
            // Update theme toggle icon
            const isDarkMode = document.body.classList.contains('dark-mode');
            const themeIcon = document.querySelector('#theme-toggle i');
            themeIcon.classList.toggle('fa-moon', !isDarkMode);
            themeIcon.classList.toggle('fa-sun', isDarkMode);
            
            // Update chart colors
            updateChartColors();
            
            alert('Theme settings applied!');
        }
        
        // Toggle sidebar function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.querySelector('#sidebar-toggle i');
            
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
            } else {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
            }
            
            // Save sidebar state
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        // Toggle mobile sidebar
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show-mobile');
        }
        
        // Search functionality
        function performSearch(query) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (!query || query.length < 2) {
                resultsContainer.classList.remove('active');
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const results = [];
            
            // Search contacts
            contacts.forEach(contact => {
                if (contact.name.toLowerCase().includes(searchTerm) || 
                    contact.email.toLowerCase().includes(searchTerm) || 
                    contact.company.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Contact',
                        icon: 'fas fa-user',
                        title: contact.name,
                        subtitle: contact.company,
                        email: contact.email,
                        id: contact.id,
                        category: 'contacts'
                    });
                }
            });
            
            // Search leads
            leads.forEach(lead => {
                if (lead.name.toLowerCase().includes(searchTerm) || 
                    lead.company.toLowerCase().includes(searchTerm) || 
                    lead.email.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Lead',
                        icon: 'fas fa-chart-line',
                        title: lead.name,
                        subtitle: lead.company,
                        email: lead.email,
                        id: lead.id,
                        category: 'leads'
                    });
                }
            });
            
            // Search tasks
            tasks.forEach(task => {
                if (task.title.toLowerCase().includes(searchTerm) || 
                    task.related.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Task',
                        icon: 'fas fa-tasks',
                        title: task.title,
                        subtitle: `Related to: ${task.related}`,
                        date: task.date,
                        id: task.id,
                        category: 'tasks'
                    });
                }
            });
            
            // Search events
            events.forEach(event => {
                if (event.title.toLowerCase().includes(searchTerm) || 
                    event.location.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Event',
                        icon: 'fas fa-calendar',
                        title: event.title,
                        subtitle: event.location,
                        date: event.date,
                        id: event.id,
                        category: 'calendar'
                    });
                }
            });
            
            // Search invoices
            invoices.forEach(invoice => {
                if (invoice.client.toLowerCase().includes(searchTerm) || 
                    invoice.description.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Invoice',
                        icon: 'fas fa-dollar-sign',
                        title: invoice.client,
                        subtitle: invoice.description,
                        amount: invoice.amount,
                        id: invoice.id,
                        category: 'revenue'
                    });
                }
            });
            
            // Display results
            if (results.length > 0) {
                resultsContainer.classList.add('active');
                
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <i class="${result.icon}"></i>
                        <div>
                            <div>${result.title}</div>
                            <small>${result.subtitle}</small>
                        </div>
                        <span class="type">${result.type}</span>
                    `;
                    
                    resultItem.addEventListener('click', () => {
                        // Switch to the appropriate tab
                        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                        document.querySelector(`.menu-item[data-tab="${result.category}"]`).classList.add('active');
                        
                        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                        document.getElementById(result.category).classList.add('active');
                        
                        // Clear search
                        document.getElementById('search-input').value = '';
                        resultsContainer.classList.remove('active');
                        
                        // View the item
                        viewItem(result.category.slice(0, -1), result.id);
                    });
                    
                    resultsContainer.appendChild(resultItem);
                });
            } else {
                resultsContainer.classList.remove('active');
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            checkAuth();
            
            // Load theme preference
            const darkModeSetting = localStorage.getItem('darkMode');
            if (darkModeSetting === 'true') {
                document.body.classList.add('dark-mode');
            } else if (darkModeSetting === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) document.body.classList.add('dark-mode');
            }
            
            // Update theme toggle icon
            const isDarkMode = document.body.classList.contains('dark-mode');
            const themeIcon = document.querySelector('#theme-toggle i');
            if (isDarkMode) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            
            // Set theme select value
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = darkModeSetting || 'light';
            }

            // Initialize notifications
            checkForNotifications();
            updateNotificationUI();
            
            // Check for notifications every hour
            setInterval(checkForNotifications, 60 * 60 * 1000);
            
            // Load sidebar state
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.querySelector('#sidebar-toggle i');
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
            }
            
            // Set up back buttons
            document.getElementById('back-to-contacts').addEventListener('click', function() {
                document.getElementById('contact-detail-view').style.display = 'none';
                document.getElementById('contacts-table').style.display = 'table';
            });
            
            document.getElementById('back-to-leads').addEventListener('click', function() {
                document.getElementById('lead-detail-view').style.display = 'none';
                document.getElementById('leads-management-table').style.display = 'table';
            });
            
            document.getElementById('back-to-tasks').addEventListener('click', function() {
                document.getElementById('task-detail-view').style.display = 'none';
                document.getElementById('tasks-management-table').style.display = 'table';
            });
            
            document.getElementById('back-to-invoices').addEventListener('click', function() {
                document.getElementById('invoice-detail-view').style.display = 'none';
                document.getElementById('invoices-table').style.display = 'table';
            });
            
            // Set up tab navigation
            const menuItems = document.querySelectorAll('.menu-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    tabContents.forEach(content => content.classList.remove('active'));
                    if (tab) {
                        document.getElementById(tab).classList.add('active');
                    }
                    
                    // On mobile, close sidebar after selecting a menu item
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('show-mobile');
                    }
                });
            });
            
            // Set up modal functionality
            const modals = document.querySelectorAll('.modal');
            const closeButtons = document.querySelectorAll('.close');
            
            // Add buttons
            document.getElementById('add-contact-btn').addEventListener('click', () => {
                document.getElementById('contact-modal-title').textContent = 'Add New Contact';
                document.getElementById('contact-id').value = '';
                document.getElementById('contact-name').value = '';
                document.getElementById('contact-email').value = '';
                document.getElementById('contact-phone').value = '';
                document.getElementById('contact-company').value = '';
                document.getElementById('contact-status').value = 'new';
                document.getElementById('contact-modal').style.display = 'flex';
            });
            
            document.getElementById('add-lead-btn').addEventListener('click', () => {
                document.getElementById('lead-modal-title').textContent = 'Add New Lead';
                document.getElementById('lead-id').value = '';
                document.getElementById('lead-name').value = '';
                document.getElementById('lead-company').value = '';
                document.getElementById('lead-email').value = '';
                document.getElementById('lead-phone').value = '';
                document.getElementById('lead-status').value = 'new';
                document.getElementById('lead-modal').style.display = 'flex';
            });
            
            document.getElementById('add-invoice-btn').addEventListener('click', () => {
                document.getElementById('invoice-modal-title').textContent = 'Add New Invoice';
                document.getElementById('invoice-id').value = '';
                // Populate client dropdown
                const clientSelect = document.getElementById('invoice-client');
                clientSelect.innerHTML = '<option value="">Select a client</option>';
                
                // Get unique clients from contacts
                const clients = [...new Set(contacts.filter(c => c.status === 'customer').map(c => c.company))];
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client;
                    option.textContent = client;
                    clientSelect.appendChild(option);
                });
                
                document.getElementById('invoice-amount').value = '';
                document.getElementById('invoice-date').value = '';
                document.getElementById('invoice-due-date').value = '';
                document.getElementById('invoice-status').value = 'pending';
                document.getElementById('invoice-description').value = '';
                document.getElementById('invoice-modal').style.display = 'flex';
            });
            
            document.getElementById('add-task-btn').addEventListener('click', () => {
                document.getElementById('task-modal-title').textContent = 'Add New Task';
                document.getElementById('task-id').value = '';
                document.getElementById('task-title').value = '';
                document.getElementById('task-related').value = '';
                document.getElementById('task-date').value = '';
                document.getElementById('task-priority').value = 'medium';
                document.getElementById('task-status').value = 'pending';
                document.getElementById('task-modal').style.display = 'flex';
            });
            
            document.getElementById('add-event-btn').addEventListener('click', () => {
                document.getElementById('event-modal-title').textContent = 'Add New Event';
                document.getElementById('event-id').value = '';
                document.getElementById('event-title').value = '';
                document.getElementById('event-date').value = '';
                document.getElementById('event-time').value = '';
                document.getElementById('event-location').value = '';
                document.getElementById('event-description').value = '';
                document.getElementById('event-modal').style.display = 'flex';
            });
            
            // Close modals
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    modals.forEach(modal => modal.style.display = 'none');
                });
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    modals.forEach(modal => modal.style.display = 'none');
                }
            });
            
            // Save buttons
            document.getElementById('save-contact').addEventListener('click', () => {
                const id = document.getElementById('contact-id').value;
                const name = document.getElementById('contact-name').value;
                const email = document.getElementById('contact-email').value;
                const phone = document.getElementById('contact-phone').value;
                const company = document.getElementById('contact-company').value;
                const status = document.getElementById('contact-status').value;
                
                if (name && email) {
                    if (id) {
                        // Update existing contact
                        const contact = contacts.find(c => c.id == id);
                        contact.name = name;
                        contact.email = email;
                        contact.phone = phone;
                        contact.company = company;
                        contact.status = status;
                    } else {
                        // Add new contact
                        const newId = contacts.length > 0 ? Math.max(...contacts.map(c => c.id)) + 1 : 1;
                        contacts.push({id: newId, name, email, phone, company, status});
                    }
                    saveData();
                    document.getElementById('contact-modal').style.display = 'none';
                } else {
                    alert('Please fill in at least name and email fields');
                }
            });
            
            document.getElementById('save-lead').addEventListener('click', () => {
                const id = document.getElementById('lead-id').value;
                const name = document.getElementById('lead-name').value;
                const company = document.getElementById('lead-company').value;
                const email = document.getElementById('lead-email').value;
                const phone = document.getElementById('lead-phone').value;
                const status = document.getElementById('lead-status').value;
                
                if (name && email) {
                    if (id) {
                        // Update existing lead
                        const lead = leads.find(l => l.id == id);
                        lead.name = name;
                        lead.company = company;
                        lead.email = email;
                        lead.phone = phone;
                        lead.status = status;
                    } else {
                        // Add new lead
                        const newId = leads.length > 0 ? Math.max(...leads.map(l => l.id)) + 1 : 1;
                        leads.push({id: newId, name, company, email, phone, status});
                    }
                    saveData();
                    document.getElementById('lead-modal').style.display = 'none';
                } else {
                    alert('Please fill in at least name and email fields');
                }
            });
            
            document.getElementById('save-invoice').addEventListener('click', () => {
                const id = document.getElementById('invoice-id').value;
                const client = document.getElementById('invoice-client').value;
                const amount = parseFloat(document.getElementById('invoice-amount').value);
                const date = document.getElementById('invoice-date').value;
                const dueDate = document.getElementById('invoice-due-date').value;
                const status = document.getElementById('invoice-status').value;
                const description = document.getElementById('invoice-description').value;
                
                if (client && amount && date && dueDate) {
                    if (id) {
                        // Update existing invoice
                        const invoice = invoices.find(i => i.id == id);
                        invoice.client = client;
                        invoice.amount = amount;
                        invoice.date = date;
                        invoice.dueDate = dueDate;
                        invoice.status = status;
                        invoice.description = description;
                    } else {
                        // Add new invoice
                        const newId = invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) + 1 : 1;
                        invoices.push({id: newId, client, amount, date, dueDate, status, description});
                    }
                    saveData();
                    document.getElementById('invoice-modal').style.display = 'none';
                } else {
                    alert('Please fill in all required fields');
                }
            });
            
            document.getElementById('save-task').addEventListener('click', () => {
                const id = document.getElementById('task-id').value;
                const title = document.getElementById('task-title').value;
                const related = document.getElementById('task-related').value;
                const date = document.getElementById('task-date').value;
                const priority = document.getElementById('task-priority').value;
                const status = document.getElementById('task-status').value;
                
                if (title && date) {
                    if (id) {
                        // Update existing task
                        const task = tasks.find(t => t.id == id);
                        task.title = title;
                        task.related = related;
                        task.date = date;
                        task.priority = priority;
                        task.status = status;
                    } else {
                        // Add new task
                        const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                        tasks.push({id: newId, title, related, date, priority, status});
                    }
                    saveData();
                    document.getElementById('task-modal').style.display = 'none';
                } else {
                    alert('Please fill in at least title and date fields');
                }
            });
            
            document.getElementById('save-event').addEventListener('click', () => {
                const id = document.getElementById('event-id').value;
                const title = document.getElementById('event-title').value;
                const date = document.getElementById('event-date').value;
                const time = document.getElementById('event-time').value;
                const location = document.getElementById('event-location').value;
                const description = document.getElementById('event-description').value;
                
                if (title && date) {
                    if (id) {
                        // Update existing event
                        const event = events.find(e => e.id == id);
                        event.title = title;
                        event.date = date;
                        event.time = time;
                        event.location = location;
                        event.description = description;
                    } else {
                        // Add new event
                        const newId = events.length > 0 ? Math.max(...events.map(e => e.id)) + 1 : 1;
                        events.push({id: newId, title, date, time, location, description});
                    }
                    saveData();
                    document.getElementById('event-modal').style.display = 'none';
                } else {
                    alert('Please fill in at least title and date fields');
                }
            });
            
            // Calendar navigation
            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
            
            // Mobile menu toggle
            document.getElementById('mobile-menu-toggle').addEventListener('click', toggleMobileSidebar);
            
            // Search functionality
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                performSearch(e.target.value);
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-bar')) {
                    document.getElementById('search-results').classList.remove('active');
                }
            });
            
            // Close sidebar when clicking outside on mobile
            if (window.innerWidth <= 768) {
                document.addEventListener('click', (e) => {
                    const sidebar = document.getElementById('sidebar');
                    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                    
                    if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target) && sidebar.classList.contains('show-mobile')) {
                        sidebar.classList.remove('show-mobile');
                    }
                });
            }
            
            // Initialize UI with data
            updateUI();
            
            // Add observer for theme changes to update chart colors
            const observer = new MutationObserver(updateChartColors);
            observer.observe(document.body, { 
                attributes: true, 
                attributeFilter: ['class'] 
            });
        });
    </script>
</body>
</html>